<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://vjs.zencdn.net/8.3.0/video-js.css" rel="stylesheet" />
  <style>
    body.capture-mode {
      cursor: crosshair;
    }

    .selection {
      border: 2px dashed red;
      position: absolute;
      pointer-events: none;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      right: 20px;
      bottom: 20px;
      background: rgba(47, 47, 47, 0.85);
      backdrop-filter: blur(15px);
      border-radius: 30px;
      padding: 20px;
      max-width: 300px;
      /* Adjust as needed */
      color: #fff;
    }

    .modal-header {
      font-size: 20px;
      margin-bottom: 10px;
    }

    .modal-tabs {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .tab {
      cursor: pointer;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .video-info {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .video-thumbnail {
      width: 80px;
      height: 80px;
      background: #333;
      /* Placeholder */
      position: relative;
      margin-right: 10px;
    }

    .video-duration {
      position: absolute;
      right: 5px;
      bottom: 5px;
      color: #fff;
      background: rgba(0, 0, 0, 0.5);
      padding: 2px 5px;
      border-radius: 5px;
      font-size: 12px;
    }

    .video-details {
      font-size: 14px;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }

    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
  </style>
  <title>Video Player</title>
</head>

<body>
  <div id="myModal" class="modal">
    <div class="modal-content">
      <span id="close-btn" class="close">&times;</span>
      <div class="modal-header" id="modal-header"></div>
      <div class="modal-tabs">
        <div class="tab active" data-tab="videos">Videos</div>
        <div class="tab" data-tab="practice">Practice</div>
        <div class="tab" data-tab="courses">Courses</div>
        <div class="tab" data-tab="learning-path">Learning Path</div>
      </div>
      <div id="videos" class="tab-content active"></div>
      <div id="practice" class="tab-content"></div>
      <div id="courses" class="tab-content"></div>
      <div id="learning-path" class="tab-content"></div>
    </div>
  </div>



  <button id="capture-btn">Capture</button>
  <script src='./player_files/tesseract.min.js'></script>
  <script src="./player_files/video.min.js"></script>
  <script type="text/javascript">
    var video;
    var selecting = false;
    var startPoint = { x: 0, y: 0 };
    var endPoint = { x: 0, y: 0 };
    var captureBtn = document.getElementById('capture-btn');
    var selection = null;
    var lo = "";
    const modal = document.getElementById("myModal");
    const span = document.getElementsByClassName("close")[0];
    const modalText = document.getElementById("modal-text");


    // Load from homepage
    const expInfo =
    {
      "_id": "645d184acb4ca0808d46a333",
      "user": "645d184acb4ca0808d46a330",
      "order": "1243",
      "videos": [
        "64329a988d77e5fc4f56c86b"
      ],
      "assessments": [
        "645bc96ad7506204d38833f3"
      ],
      "__v": 0
    };


    // These two types of contents should be able to fetch from /videos and /assmt respectively,
    // but I haven't uploaded new examples following new schemas to the backend.
    // You may use these two objs to develop at this moment.
    const materials = []
    materials.push({
      // Fetch from https://curio.oli.cmu.edu/videos/64329a988d77e5fc4f56c86b
      video: {
        "learningObjs": ["overfit", "regularization"],
        "_id": "64329a988d77e5fc4f56c86b",
        "title": "3-11_Regularized_logistic_regression",
        "description": "Course: \"ML_Specialization_Supervised_Learning\"",
        "filename": "/contents/ML_Specialization_Supervised_Learning/videos/3-11 Regularized logistic regression.mp4",
        "captionFile": "/contents/ML_Specialization_Supervised_Learning/captions/3-11 Regularized logistic regression.vtt",
        "__v": 0
      },
      // Fetch from https://curio.oli.cmu.edu/assmt/645bc96ad7506204d38833f3
      assessment:
      {
        "_id": "645bc96ad7506204d38833f3",
        "description": "TEST001",
        "options": [
          "{}"
        ],
        "__v": 0
      }
    })

    span.onclick = function () {
      modal.style.display = "none";
    }

    window.onclick = function (event) {
      if (event.target == modal) {
        modal.style.display = "none";
      }
    }

    async function searchVideos(text, userID) {
      try {
        const response = await fetch("https://curio.oli.cmu.edu/videos/search", {
          method: "POST",
          body: new URLSearchParams({
            text,
            lo,
            userID
          }),
        });
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return await response.json();
      } catch (error) {
        console.error('Error:', error);
      }
    }

    function initPlayer(material) {
      const player = document.createElement('video');
      player.setAttribute('id', 'my-video');
      player.setAttribute('class', 'video-js');
      player.setAttribute('crossorigin', 'anonymous');
      
      // Available attrs:
      // https://videojs.com/guides/options
      player.setAttribute('data-setup', `{
        "preload": "auto",
        "controls": "controls",
        "width": "640",
        "height": "360"
      }`);

      // Remove https://curio.oli.cmu.edu/ in production env.
      player.innerHTML = 
      `
        <source
          src="https://curio.oli.cmu.edu/${material.video.filename}"
          type="video/mp4">
        <track kind="captions"
          src="https://curio.oli.cmu.edu/${material.video.captionFile}"
          srclang="en" label="English" default>
      `
      document.body.insertBefore(player, document.body.firstChild);
      return document.body.insertBefore(player, document.body.firstChild);
    }

    function msToTime(s) {
      function pad(n, z) {
        z = z || 2;
        return ('00' + n).slice(-z);
      }

      var ms = s % 1000;
      s = (s - ms) / 1000;
      var secs = s % 60;
      s = (s - secs) / 60;
      var mins = s % 60;
      var hrs = (s - mins) / 60;

      return pad(hrs) + ':' + pad(mins) + ':' + pad(secs) + '.' + pad(ms, 3);
    }

    function startSelection(e) {
      selecting = true;
      startPoint = { x: e.offsetX, y: e.offsetY };

      // Create selection element
      selection = document.createElement('div');
      selection.className = 'selection';
      selection.style.left = `${startPoint.x}px`;
      selection.style.top = `${startPoint.y}px`;
      document.body.appendChild(selection);
    }

    function updateSelection(e) {
      if (!selecting || !selection) return;
      endPoint = { x: e.offsetX, y: e.offsetY };

      // Calculate left and top for the selection
      const left = Math.min(startPoint.x, endPoint.x);
      const top = Math.min(startPoint.y, endPoint.y);

      // Update selection element
      selection.style.width = `${Math.abs(endPoint.x - startPoint.x)}px`;
      selection.style.height = `${Math.abs(endPoint.y - startPoint.y)}px`;
      selection.style.left = `${left}px`;
      selection.style.top = `${top}px`;
    }

    function stopSelection(e) {
      selecting = false;
      endPoint = { x: e.offsetX, y: e.offsetY };

      // Remove selection element
      if (selection) {
        document.body.removeChild(selection);
        selection = null;
      }

      stopCaptureMode(); // Call stopCaptureMode here
      detect();
    }

    function capture(video, x, y, w, h) {
      const bBox = video.getBoundingClientRect();
      const scaleX = video.videoWidth / bBox['width'];
      const scaleY = video.videoHeight / bBox['height'];

      const canvas = document.createElement('canvas');
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video,
        x * scaleX, y * scaleY,
        w * scaleX, h * scaleY,
        0, 0,
        w, h);
      return canvas;
    }

    const detect = async () => {
      const video = document.getElementById('my-video_html5_api');
      const width = Math.abs(endPoint.x - startPoint.x);
      const height = Math.abs(endPoint.y - startPoint.y);
      const x = Math.min(startPoint.x, endPoint.x);
      const y = Math.min(startPoint.y, endPoint.y);

      if (width <= 0 || height <= 0) {
        console.log('Invalid selection area. Please make sure the selection width and height are greater than 0.');
        return;
      }
      const canvas = capture(video, x, y, width, height);


      canvas.toBlob(async (blob) => {
        const worker = await Tesseract.createWorker();
        await worker.loadLanguage('eng');
        await worker.initialize('eng');
        await worker.setParameters({
          tessedit_ocr_engine_mode: Tesseract.OEM.LSTM_ONLY,
          tessedit_pageseg_mode: Tesseract.SPARSE_TEXT,
        });
        const output = await worker.recognize(blob);
        console.log(output);
        console.log(output.data.text);
        // Inside your detect function, after getting output.data.text
        const outputText = output.data.text;
        const userID = "your-user-id";  // TODO: Replace with actual user id

        // After defining the videos array...
        const modal = document.getElementById("myModal");
        const modalHeader = document.getElementById("modal-header");
        const videosTab = document.getElementById("videos");
        const tabs = Array.from(document.getElementsByClassName("tab"));
        const tabContents = Array.from(document.getElementsByClassName("tab-content"));

        modalHeader.innerText = outputText;

        tabs.forEach(tab => {
          tab.addEventListener("click", () => {
            const target = tab.dataset.tab;

            tabs.forEach(t => t.classList.remove("active"));
            tabContents.forEach(t => t.classList.remove("active"));

            tab.classList.add("active");
            document.getElementById(target).classList.add("active");
          });
        });

        // Close the modal when the close span is clicked
        span.onclick = function () {
          modal.style.display = "none";
        }

        // TODO: when SwaggerUI is implemented use below code
        const searchRes = await searchVideos(outputText, userID);
        console.log(searchRes);
        // Display videos in the modal
        let videoList = "";
        searchRes.hits.hits.forEach(hit => {
          const meta = hit._source;
          videoList += `
            <div class="video-info">
              <div class="video-thumbnail">
                <span class="video-duration">
                00:00</span>
          </div>
          <div class="video-details">
          <p><strong>Caption:</strong> ${meta.text}</p>
          <p><strong>Extracted:</strong> ${meta.screen_extracted}</p>
          <p><strong>Course:</strong> ${meta.course_name.replaceAll('_', ' ')}</p>
          <p><strong>Timecode:</strong> ${msToTime(meta.start_time)} -> ${msToTime(meta.end_time)}</p>
          </div>
          </div>
          `
          videoList += hit._source.video_title.replaceAll('_', ' ') + "<br>";  // Assuming each video has a title
        });
        videosTab.innerHTML = videoList;
        modal.style.display = "block";
      });
    };


    function startCaptureMode() {
      document.body.classList.add('capture-mode');
      video.addEventListener('mousedown', startSelection);
      video.addEventListener('mousemove', updateSelection);
      video.addEventListener('mouseup', stopSelection);
    }

    function stopCaptureMode() {
      document.body.classList.remove('capture-mode');
      video.removeEventListener('mousedown', startSelection);
      video.removeEventListener('mousemove', updateSelection);
      video.removeEventListener('mouseup', stopSelection);
    }

    captureBtn.addEventListener('click', startCaptureMode);
    window.addEventListener('load', () => {
      video = initPlayer(materials[0]);
    })

  </script>
</body>

</html>
